---
title: "BMIN503/EPID600 Project Template"
author: "Brooke Luo"
output: 
  html_document:
    toc: false 
    depth: 3 
    theme: paper 
    highlight: tango
---
```{r set-options, echo=FALSE, cache=FALSE}
options(width = 400)
```  
***
Use this template to complete your project throughout the course. Your Final Project presentation in class will be based on the contents of this document. Replace the title/name and text below with your own, but leave the headers.

### Overview
In this section, give a brief a description of your project and its goal, what data you are using to complete it, and what three faculty/staff in different fields you have spoken to about your project with a brief summary of what you learned from each person. Include a link to your final project GitHub repository.


### Introduction 
The Emergency Department (ED) is an integral part of the hospital admission process accounting for nearly half of all hospital admissions in the United States. However, admission wait times vary in the ED and is influenced by many variables throughout the hospital. At Children's Hospital of Philadelphia, we have taken an iterative approach using quality improvement methodologies and the electronic health record (EHR) to streamline the admission process and improve communication from ED to IP staff, however variation in transfer times still remain. Delays in ED to IP transfer of care can impact hospital resources, increase ED crowding, and decrease patient satisfaction. These variables are difficult to identify and can vary throughout the year making it difficult to know where to focus quality improvement (QI) efforts. Historically, QI methods involve creating a diagram (ie. driver diagram, cause and effect diagram) that captures key elements of a specific workflow, from which a list of actionable items is generated. The Pareto Principle is then applied to determine which actionable items can improve the outcome the most. These changes then undergo evaluation through a Plan-Do-Study-Act cycle with the hopes of finding measurable improvements to quality of patient care. In a complex outcome such as ED admission wait times, it is influenced by many factors throughout the hospital making QI efforts difficult to determine. With the skills learned in class, I hope to introduce a novel approach to QI by using machine learning to determine the key drivers that influence our hospitalâ€™s ED admission wait times, and use those identified variables to determine QI efforts.
Objective: To determine if 1) machine learning methods can provide a framework for finding variables that significantly influence ED admission wait times and therefore direct QI efforts. 2) to determine if machine learning is a valid approach to use to predict ED wait times.

In the second paragraph, explain why your problem is interdisciplinary, what fields can contribute to its understanding, and incorporate background related to what you learned from meeting with faculty/staff #i feel like I answered this already in the above paragraph.

###Methods Overview:
Libraries used:
```{r}
#update all librarys; remove all variables
rm(list = ls())  #Start with a clean slate
library(ggplot2)
library(dplyr)
library(tidyverse)
library(magrittr)
library(lubridate)
```

1. Clean up the data first (numbers are numbers, dates are dates etc)
```{r}
#upload and configure the data
#filename: MDrptEtc_20181027_FY17on
rm(list=ls())
data.all.admission <- read.csv(file="MDrptEtc_20181027_FY17on.csv", header=TRUE)
data.ED.admission <-read.csv(file="MDrptWithBedReqandAdmitTeam_20181104_FY17on.csv", header=TRUE)

head(data.all.admission)

#combine column...based on mrn and date?
```



2. Make new columns with cleaned up data - Diagnosis, etc
```{r}

colnames(data.all.admission)
all.admits.r <- dplyr::rename(data.all.admission,
                       ARRIVAL_DATE_TIME=HOSP_ADMIT_DT,  #time patient presented to ED / arrived in hospital
                       ADMIT_FROM=ADMIT_EVENT_ACTION_ABBR, #where they were admitted from (ED, periop, direct admission)
                       BED_REQUEST_DATE_TIME = MRFT_BED_REQ_DT_TM,  #time the last bed request order was placed
                       MD_PAGED_DATE_TIME = MD_PAGED_DT_TM,  #time the MD was marked as paged (variable)
                       MD_REPORT_DATE_TIME=MD_RPT_DT_TM,  #time MD report was clicked as completed
                       ADMIT_INPATIENT_DATE_TIME=CENSUS_ADMIT_TM,  #Admit to inpatient order time; proxy time pt arrived on the floor
                       DIAGNOSIS = ACCT_ADMIT_DX_NM, #diagnosis from the ED
                       MRN = PAT_MRN_ID,  #patient Identifier
                       TEAM_ED=ED_DISCH_TEAM,  #ED team who took care of this patient in ED
                       INPATIENT_FLOOR=CENSUS_ADMIT_DEPT,  #inpatient floor location where the patient was admitted 
                       INPATIENT_SERVICE=CENSUS_ADMIT_SERVCIE  #inpatient team who admitted the patient
                      )

head(data.ED.admission)
ED.admits.r<- dplyr::rename(data.ED.admission,
                              ARRIVAL_DATE_TIME=HOSP_ADMIT_DT,  #time patient presented to ED / arrived in hospital
                              ADMIT_FROM=ADMIT_EVENT_ACTION_ABBR, #where they were admitted from (ED, periop, direct admission)
                              BED_REQUEST_DATE_TIME = MRFT_BED_REQ_DT_TM,  #time the last bed request order was placed
                              BED_ASSIGNED_DATE_TIME = BED_ASSIGN_DT_TM,  #time bed was assigned in the inpatient unit 
                              MD_PAGED_DATE_TIME = MD_PAGED_DT_TM,  #time the MD was marked as paged (variable)
                              MD_REPORT_DATE_TIME=MD_RPT_DT_TM,  #time MD report was clicked as completed
                              TEAM_ASSIGNED_DATE_TIME=ADMIT_TREATMENT_START_DT, #time inpatient team assigned themselves to treatment team
                              ADMIT_INPATIENT_DATE_TIME=CENSUS_ADMIT_TM,  #Admit to inpatient order time; proxy time pt arrived on the floor
                              DIAGNOSIS = ACCT_ADMIT_DX_NM, #diagnosis from the ED
                              MRN = PAT_MRN_ID,  #patient Identifier
                              TEAM_ED=ED_DISCH_TEAM,  #ED team who took care of this patient in ED
                              INPATIENT_TEAM=ADMIT_TREATMENT_TEAM, #team who take care of the patient
                              INPATIENT_FLOOR=CENSUS_ADMIT_DEPT,  #inpatient floor location where the patient was admitted 
                              INPATIENT_SERVICE=CENSUS_ADMIT_SERVCIE  #inpatient team who admitted the patient
                                )



ED.clean<-ED.admits.r %>%
  dplyr::select(MRN,ARRIVAL_DATE_TIME, BED_REQUEST_DATE_TIME, BED_ASSIGNED_DATE_TIME, MD_PAGED_DATE_TIME, MD_REPORT_DATE_TIME, TEAM_ASSIGNED_DATE_TIME, ADMIT_INPATIENT_DATE_TIME, DIAGNOSIS,TEAM_ED,INPATIENT_FLOOR,INPATIENT_TEAM, INPATIENT_SERVICE)

#Convert all time variables into a readable time format using library lubridate; and convert all string variables to "characters"
ED.clean$ARRIVAL_DATE_TIME<-ymd_hms(ED.clean$ARRIVAL_DATE_TIME)
ED.clean$BED_REQUEST_DATE_TIME<-ymd_hms(ED.clean$BED_REQUEST_DATE_TIME)
ED.clean$BED_ASSIGNED_DATE_TIME<-ymd_hms(ED.clean$BED_ASSIGNED_DATE_TIME)
ED.clean$MD_PAGED_DATE_TIME<-ymd_hms(ED.clean$MD_PAGED_DATE_TIME)
ED.clean$MD_REPORT_DATE_TIME<-ymd_hms(ED.clean$MD_REPORT_DATE_TIME)
ED.clean$TEAM_ASSIGNED_DATE_TIME<-ymd_hms(ED.clean$TEAM_ASSIGNED_DATE_TIME)
ED.clean$ADMIT_INPATIENT_DATE_TIME<-ymd_hms(ED.clean$ADMIT_INPATIENT_DATE_TIME)
ED.clean$DIAGNOSIS<-as.character(ED.clean$DIAGNOSIS)

#Outcome durations of interest:  (1) Time of Bed request to MD report; (2) Time from MD report to arrival on the floor
ED.clean$dur1.request.report<-difftime(ED.clean$MD_REPORT_DATE_TIME,ED.clean$BED_REQUEST_DATE_TIME, units="min")
ED.clean$dur2.report.floor<-difftime(ED.clean$ADMIT_INPATIENT_DATE_TIME, ED.clean$MD_REPORT_DATE_TIME, units="min")
#limitations: alot of times MD report is clicked right before the patient is sent up to the floor, so this number is probably falsely decreased
ED.clean$tot.dur<- difftime(ED.clean$ADMIT_INPATIENT_DATE_TIME, ED.clean$BED_REQUEST_DATE_TIME, units="min") 

#additional columns to understand the data
##1: day of the week of bed request:
ED.clean$dayofweek = weekdays(as.Date(ED.clean$BED_REQUEST_DATE_TIME))  #returns what day of the week  the patient arrived to the hospital

##2: Time of day of bed request
ED.clean$timeofday= hour(ED.clean$BED_REQUEST_DATE_TIME)
ED.clean$bed_request_date=as.Date(ED.clean$BED_REQUEST_DATE_TIME)

##3: #number of total admission for that day 
a=ED.clean %>%  #look through all ED admissions
  group_by(as.Date(BED_REQUEST_DATE_TIME)) %>%  #group bed requests by date
  summarise(tot_ED_admits.day=n())  #count the total # of bed requests per day; and spit out the number of ED admissions by day
ED.admits.per.day<-dplyr::rename(a, bed_request_date= "as.Date(BED_REQUEST_DATE_TIME)")  #rename column in ED.admits.per.day so both tables will have a column called "bed_request_date" so they can be merged
ED.clean.2=inner_join(ED.clean,ED.admits.per.day,by="bed_request_date")  #merge ED.clean with ED.admits.per.day to obtain column of total admissions that day
ED.clean.3<-ED.clean.2 %>%   #get rid of outliers (if duration is outside range of 0-1000 min, it likely was an error)
  filter(tot.dur>0 & tot.dur<1000) %>%
  return

head(ED.clean.3)
#convert durations from minutes to numeric to do calculations
ED.clean.3$dur1.request.report<-as.integer(ED.clean.3$dur1.request.report)
ED.clean.3$dur2.report.floor<-as.integer(ED.clean.3$dur2.report.floor)
ED.clean.3$tot.dur<-as.integer(ED.clean.3$tot.dur)
head(ED.clean.3)

##4:  Column for grouped diagnoses - Respiratory
#Distinct Diagnoses:  There are 3069 different ED diagnoses that were entered

#find all respiratory diagnoses
diag.resp=ED.admits.r %>%
  dplyr::select(DIAGNOSIS) %>%
  distinct(DIAGNOSIS) %>%
  filter(grepl('asthma|respi|bronchiolitis', DIAGNOSIS, ignore.case = TRUE)) %>%
  return

a<-vector(); group.diag<-vector()
#for loop: finds all diagnoses that contain "asthma, respi, bronchiolitis" and replaces it with "respiratory distress"
for(i in 1:nrow(ED.clean.3)){
  a<-grepl('asthma|respi|bronchiolitis', ED.clean.3$DIAGNOSIS[[i]], ignore.case = TRUE)
  if(a=="TRUE"){group.diag[i]<- "respiratory distress"}
  else{group.diag[i]<-ED.clean.3$DIAGNOSIS[i]}
}
ED.clean.3$grouped.diagnoses<-group.diag #add to the table of clean data


```



3. Trends:
```{r}
#Plot 1:  average tot.duration by location
ggplot(data=ED.clean.3,
       aes(x=tot_ED_admits.day, y=tot.dur)) +  #x and y axes
       geom_boxplot()

       

##sample ggplot from hw6;  just a reference
ggplot(df_boxplot.b, aes(x=status,y=expression)) +
  geom_boxplot(outlier.colour=NA, color="grey18", fill="lightgreen") +
  stat_boxplot(geom='errorbar', color="grey18") +
  geom_jitter(size=1, position=position_jitter(width=0.3)) +
  ggtitle("Boxplot for probe 201468_s_at") +
  xlab("")+
  ylab("RMA-intensity")+
  theme_bw() +
  theme(legend.position="none")
#Plot 2: average tot.duration by team

#Plot 3: average total.duration by day of the week

#plot 4: 
```




Basket of evaluations for now:
```{r}




#ED.data.renamed <- rename(ED.data, diagnosis=ACCT_ADMIT_DX_NM, mrn=PAT_MRN_ID,  admitted_from=FROM_DEPT, admit_floor=CENSUS_ADMIT_DEPT, time_bed_request = MRFT_BED_REQ_DT_TM, time_md_paged=MD_PAGED_DT_TM, treatment_team_start_time = ADMIT_TREATMENT_START_DT, time_bed_assigned = BED_ASSIGN_DT_TM,  time_md_report=MD_RPT_DT_TM, ed_team=ED_DISCH_TEAM, admit_service_team=CENSUS_ADMIT_SERVCIE, time_of_arrival=HOSP_ADMIT_DT, time_of_admission=CENSUS_ADMIT_TM )
#wish list:  bed assignment time; Inpatient team

#calculations
# need time between bed request and MD paged, time between MD paged and MD report, time between Bed request and MD report, time to bed request and patient hitting the floor (probably the actual outcome measure)
#Things that seem to be missing:demographics of the patient, age, # of medications, problems on the problem list, # of labs ordered
#could complexity be a proxy measure by duration of admission?
#new.columns.data

##quick code to convert to days of the week!!!!  cool
#crime_date = as.Date(ymd_hms(ED.clean$time_bed_assigned))
#summary(crime_date)
#crime_date_dotw=weekdays(crime_date)
#hist(crime_date, breaks="month")


#convert time data to be computable
col1 <-ymd_hms(admissions.data.renamed$time_bed_request) ##add a column that looks at time_hour, and takes out the hour the flight was scheduled to depart
col2 <-ymd_hms(admissions.data.renamed$time_md_paged)
col3 <-ymd_hms(admissions.data.renamed$time_md_report)
col4 <-ymd_hms(admissions.data.renamed$time_of_admission)

#calculate durations between points of interest
duration.bedrequesttomdpage <-difftime(col2,col1,units="min")  #duration between time of bed request to MD page 
duration.mdpagetomdreport <-difftime(col3,col2, units="min")  #duration between MD paged to MD report given
duration.mdreporttotime_of_admission <-difftime(col4,col3, units="min")  #duration between MD reported to Time of Admission
total.duration<-difftime(col4,col1, units="min") #duration between time MD was paged to Time of Admission
#add columns to data table
data.with.durations<-cbind(admissions.data.renamed, duration.bedrequesttomdpage, duration.mdpagetomdreport, duration.mdreporttotime_of_admission, total.duration)
summary(a)

#look at ED data set only
col1a <-ymd_hms(ED.data.renamed$time_bed_request) ##add a column that looks at time_hour, and takes out the hour the flight was scheduled to depart
col2a <-ymd_hms(ED.data.renamed$time_bed_assigned) #time of bed assignment
col3a<-ymd_hms(ED.data.renamed$time_md_paged)#time of MD paged
col4a<-ymd_hms(ED.data.renamed$time_md_report) #Time MD report was given
col5a <-ymd_hms(ED.data.renamed$time_of_admission)  #time of admission on inpatient

duration21<-difftime(col2a,col1a, units="min") #time between bed assigned (2) and bed request (1)
duration_pagetorequest<-difftime(col3a,col1a, units="min")  #time between MD page and bed request
duration32<-difftime(col3a,col2a, units="min") #time between MD paged and bed assigned;  if negative, specialty team was consulted (and button was clicked, but not the time that the team actually signed out)
duration42<-difftime(col4a,col2a, units="min") # time between MD report and bed assigned
duration41<-difftime(col4a,col1a, units="min")  #total duration between time of bed request to MD Report
duration54<-difftime(col5a,col4a, units="min")  #total duration between MD report to bed admission time
n<-duration54<(-0)
summary(n)
ED.data.with.durations<-cbind(duration32, duration42, poop, duration_pagetorequest, ED.data.renamed)


#total duration from bed request to time of admission on the floor
#errors:  large durations due to being admitted to PICU after being admitted to floor or just an error in general
#find the outliers here
poop<- difftime(col5a,col1a,unit="min")
which(poop>1000)
a=ED.data.with.durations[281,]
str(a)
str(poop)
mean(poop[1:37241], na.rm=TRUE)
median(poop[1:37241], na.rm=TRUE)

#plots
ggplot(data=ED.data.with.durations,aes(x=year(col1a), y=poop)) +
        geom_boxplot()

#NOTE:  bed request to MD report shoudl be the time outcome measure;  the bed request is when teh patient is deemed medically safe to initiate finding a bed.  MD report is when the MD has given the report.  The time between Bed request to MD page is loaded with errors (1/3 of the time MD paged is referring to when consult team is paged, other time is missing), the time between MD 

#Filter to only see ED admissions
ed.admissions <- data.with.durations %>%
  filter(admitted_from != "ED") %>%
  group_by(hour(ymd_hms(time_of_admission))) %>%
  summarize(count=n()) %>%
  arrange(desc(count))
poop1 <- cbind(ed.admissions[,1], ed.admissions[,2]*100/sum(ed.admissions[,2]))

month(ymd_hms(data.with.durations$time_bed_request))

# Total count of all admissions from ED:: GROUP BY TREATMENT TEAM
num.ed.admissions <- ED.data.with.durations %>%
  filter(admitted_from=="ED") %>%
  group_by(ADMIT_TREATMENT_TEAM) %>%
  summarize(count=n())%>%
  arrange(desc(count)) 
a=cbind(num.ed.admissions[,1] , (num.ed.admissions[,2]/sum(num.ed.admissions[,2])*100))

## Total count of all admissions from ED: Group by floor
num.ed.admissions <- ED.data.with.durations %>%
  filter(admitted_from=="ED") %>%
  group_by(admit_floor) %>%
  summarize(count=n())%>%
  arrange(desc(count)) 
b=cbind(num.ed.admissions[,1] , (num.ed.admissions[,2]/sum(num.ed.admissions[,2])*100))

## Total count of all admissions from ED: Group by service
num.ed.admissions <- ED.data.with.durations %>%
  filter(admitted_from=="ED") %>%
  group_by(admit_service_team) %>%
  summarize(count=n())%>%
  arrange(desc(count)) 
c=cbind(num.ed.admissions[,1] , (num.ed.admissions[,2]))
#54% of all admissions at CHOP come from the ED

#Top diagnoses admitted from ED
admission.diagnoses<- data.with.durations %>%
  filter(admitted_from=="ED") %>%
  group_by(diagnosis) %>%
  summarize(count=n()) %>%
  arrange(desc(count)) 

#If the diagnosis has the word asthma in it, then rename diagnosis as asthma
#The top 10 admission diagnoses included - fever, dyspnea, acute bronchiolitis, vomiting, convulsions, abdominal pain, appendicitis, asthma, ARDS, pneumonia, dehydration, wheezing, SS crisis, headache, cough.  But asthma shows up in a bunch of the various diagnoses.

#graphs
#X=

# graph 2: X - floor they were admitted to, Y duration
# graph 3: 
# when bed gets requested and then changed

  
#counts of admissions in 1 day, overlaid with admission duration time 
#filter
# look only at kids admitted from the ED

```


### Methods
In the first paragraph, describe the data used and general methodological approach. Subsequently, incorporate full R code necessary to retrieve and clean data, and perform analysis. Be sure to include a description of code so that others (including your future self) can understand what you are doing and why. 

```{r}
#clean up the data:
# Basic graph plots of time to admission from ED to arrival on inpatient
# graph 2: X - floor they were admitted to, Y duration
# graph 3: 
```

### Results
Describe your results and include relevant tables, plots, and code/comments used to obtain them. End with a brief conclusion of your findings related to the question you set out to address. You can include references if you'd like, but this is not required.
