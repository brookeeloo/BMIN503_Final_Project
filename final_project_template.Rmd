---
title: "BMIN503/EPID600 Project Template"
author: "Brooke Luo"
output: 
  html_document:
    toc: false 
    depth: 3 
    theme: paper 
    highlight: tango
---
```{r set-options, echo=FALSE, cache=FALSE}
options(width = 400)

#NOTES TO SELF:
# surgical ED visits are counted twice - once to periop and once to 4ST, need to rectify this eventually

```  
***
Use this template to complete your project throughout the course. Your Final Project presentation in class will be based on the contents of this document. Replace the title/name and text below with your own, but leave the headers.

### Overview
In this section, give a brief a description of your project and its goal, what data you are using to complete it, and what three faculty/staff in different fields you have spoken to about your project with a brief summary of what you learned from each person. Include a link to your final project GitHub repository.


### Introduction 
The Emergency Department (ED) is an integral part of the hospital admission process accounting for nearly half of all hospital admissions in the United States. However, admission wait times vary in the ED and is influenced by many variables throughout the hospital. At Children's Hospital of Philadelphia, we have taken an iterative approach using quality improvement (QI) methodologies and the electronic health record (EHR) to streamline the admission process and improve communication from ED to inpatient (IP) staff, however variation in transfer times still remain. Delays in ED to IP transfer of care can impact hospital resources, increase ED crowding, and decrease patient satisfaction. 

Historically, QI methods involve creating a diagram (ie. driver diagram, cause and effect diagram) that captures key elements of a specific workflow, from which a list of actionable items is generated. These actionable items then undergo evaluation through a Plan-Do-Study-Act cycle with the hopes of finding measurable improvements to quality of patient care. In a complex outcome such as ED admission wait times, it is influenced by many factors throughout the hospital making QI efforts difficult to determine. These variables are difficult to identify and can vary throughout the year making it difficult to know where to focus quality improvement (QI) efforts. With the skills learned in class, I hope to introduce a novel approach to QI by using machine learning to determine the key drivers that influence our hospitalâ€™s ED admission wait times, and use those identified variables to determine QI efforts.

Objective: To determine if 1) we can identify variables that seem to significantly impact ED wait times, 2) determine if machine learning methods can provide a framework for finding variables that significantly influence ED admission wait times and therefore direct QI efforts. 3) determine if machine learning is a valid approach to use to predict ED wait times.

This project is interdisciplinary because it is using the concepts of descriptive analysis and machine learning, but adapted into a well established hospital quality improvement framework used throughout the world today for process improvement.  

In the second paragraph, explain why your problem is interdisciplinary, what fields can contribute to its understanding, and incorporate background related to what you learned from meeting with faculty/staff #i feel like I answered this already in the above paragraph.

###Methods Overview:
Libraries used:
```{r, message=FALSE}
#update all librarys; remove all variables
library(ggplot2)
library(gridExtra)
library(dplyr)
library(tidyverse)
library(magrittr)
library(lubridate)
```

## Data Cleaning / Wrangling - Clean up the data first (numbers are numbers, dates are dates etc)
```{r}
#upload and configure the data
#filename: MDrptEtc_20181027_FY17on
rm(list=ls())
data.all.admission <- read.csv(file="MDrptEtc_20181027_FY17on.csv", header=TRUE)
data.ED.admission <-read.csv(file="MDrptWithBedReqandAdmitTeam_20181104_FY17on.csv", header=TRUE)

head(data.all.admission)

#combine column...based on mrn and date?
```



2. Make new columns with cleaned up data - Diagnosis, etc
```{r}
#All admissions with cleaned up column headings
colnames(data.all.admission)
all.admits.r <- dplyr::rename(data.all.admission,
                      ARRIVAL_DATE_TIME=HOSP_ADMIT_DT,  #time patient presented to ED / arrived in hospital
                       ADMIT_FROM=ADMIT_EVENT_ACTION_ABBR, #where they were admitted from (ED, periop, direct admission)
                       BED_REQUEST_DATE_TIME = MRFT_BED_REQ_DT_TM,  #time the last bed request order was placed
                       MD_PAGED_DATE_TIME = MD_PAGED_DT_TM,  #time the MD was marked as paged (variable)
                       MD_REPORT_DATE_TIME=MD_RPT_DT_TM,  #time MD report was clicked as completed
                       ADMIT_INPATIENT_DATE_TIME=CENSUS_ADMIT_TM,  #Admit to inpatient order time; proxy for when pt arrived on floor
                       DIAGNOSIS = ACCT_ADMIT_DX_NM, #diagnosis from the ED
                       MRN = PAT_MRN_ID,  #patient Identifier
                       TEAM_ED=ED_DISCH_TEAM,  #ED team who took care of this patient in ED
                       INPATIENT_FLOOR=CENSUS_ADMIT_DEPT,  #inpatient floor location where the patient was admitted 
                       INPATIENT_SERVICE=CENSUS_ADMIT_SERVCIE  #inpatient team who admitted the patient
                      )

#ED admissions with cleaned up column headings
ED.admits.r<- dplyr::rename(data.ED.admission,
                              ARRIVAL_DATE_TIME=HOSP_ADMIT_DT,  #time patient presented to ED / arrived in hospital
                              ADMIT_FROM=ADMIT_EVENT_ACTION_ABBR, #where they were admitted from (ED, periop, direct admission)
                              BED_REQUEST_DATE_TIME = MRFT_BED_REQ_DT_TM,  #time the last bed request order was placed
                              BED_ASSIGNED_DATE_TIME = BED_ASSIGN_DT_TM,  #time bed was assigned in the inpatient unit 
                              MD_PAGED_DATE_TIME = MD_PAGED_DT_TM,  #time the MD was marked as paged (variable)
                              MD_REPORT_DATE_TIME=MD_RPT_DT_TM,  #time MD report was clicked as completed
                              TEAM_ASSIGNED_DATE_TIME=ADMIT_TREATMENT_START_DT, #time inpatient team assigned themselves to treatment team
                              ADMIT_INPATIENT_DATE_TIME=CENSUS_ADMIT_TM,  #Admit to inpatient order time; proxy time pt arrived on the floor
                              DIAGNOSIS = ACCT_ADMIT_DX_NM, #diagnosis from the ED
                              MRN = PAT_MRN_ID,  #patient Identifier
                              TEAM_ED=ED_DISCH_TEAM,  #ED team who took care of this patient in ED
                              INPATIENT_TEAM=ADMIT_TREATMENT_TEAM, #team who take care of the patient
                              INPATIENT_FLOOR=CENSUS_ADMIT_DEPT,  #inpatient floor location where the patient was admitted 
                              INPATIENT_SERVICE=CENSUS_ADMIT_SERVCIE  #inpatient team who admitted the patient
                                )

ED.clean<-ED.admits.r %>%
  dplyr::select(MRN,ARRIVAL_DATE_TIME, BED_REQUEST_DATE_TIME, BED_ASSIGNED_DATE_TIME, MD_PAGED_DATE_TIME, MD_REPORT_DATE_TIME, TEAM_ASSIGNED_DATE_TIME, ADMIT_INPATIENT_DATE_TIME, DIAGNOSIS,TEAM_ED,INPATIENT_FLOOR,INPATIENT_TEAM, INPATIENT_SERVICE)

#CLEAN UP:  Convert all time variables into a readable time format using library lubridate; and convert all string variables to "characters"
ED.clean$MRN<-as.character(ED.clean$MRN)
ED.clean$ARRIVAL_DATE_TIME<-ymd_hms(ED.clean$ARRIVAL_DATE_TIME)
ED.clean$BED_REQUEST_DATE_TIME<-ymd_hms(ED.clean$BED_REQUEST_DATE_TIME)
ED.clean$BED_ASSIGNED_DATE_TIME<-ymd_hms(ED.clean$BED_ASSIGNED_DATE_TIME)
ED.clean$MD_PAGED_DATE_TIME<-ymd_hms(ED.clean$MD_PAGED_DATE_TIME)
ED.clean$MD_REPORT_DATE_TIME<-ymd_hms(ED.clean$MD_REPORT_DATE_TIME)
ED.clean$TEAM_ASSIGNED_DATE_TIME<-ymd_hms(ED.clean$TEAM_ASSIGNED_DATE_TIME)
ED.clean$ADMIT_INPATIENT_DATE_TIME<-ymd_hms(ED.clean$ADMIT_INPATIENT_DATE_TIME)
ED.clean$DIAGNOSIS<-as.character(ED.clean$DIAGNOSIS)
ED.clean$TEAM_ED<-as.character(ED.clean$TEAM_ED)
ED.clean$INPATIENT_FLOOR<-as.character(ED.clean$INPATIENT_FLOOR)
ED.clean$INPATIENT_TEAM<-as.character(ED.clean$INPATIENT_TEAM)
ED.clean$INPATIENT_SERVICE<-as.character(ED.clean$INPATIENT_SERVICE)

head(ED.clean)

## ADDITIONAL COLUMNS OF INTEREST:
#Outcome durations of interest:  (1) Time of Bed request to MD report; (2) Time from MD report to arrival on the floor
ED.clean$dur1.request.report<-difftime(ED.clean$MD_REPORT_DATE_TIME,ED.clean$BED_REQUEST_DATE_TIME, units="min")
ED.clean$dur2.report.floor<-difftime(ED.clean$ADMIT_INPATIENT_DATE_TIME, ED.clean$MD_REPORT_DATE_TIME, units="min")
#limitations: alot of times MD report is clicked right before the patient is sent up to the floor, so this number is probably falsely decreased
ED.clean$dur.request.bedassign <- difftime(ED.clean$BED_ASSIGNED_DATE_TIME, ED.clean$BED_REQUEST_DATE_TIME, units="min")
ED.clean$dur.bedassign.report <-difftime(ED.clean$MD_REPORT_DATE_TIME, ED.clean$BED_ASSIGNED_DATE_TIME, units="min")
ED.clean$tot.dur<- difftime(ED.clean$ADMIT_INPATIENT_DATE_TIME, ED.clean$BED_REQUEST_DATE_TIME, units="min") 

#Additional columns to understand the data
ED.clean$dayofweek = weekdays(as.Date(ED.clean$BED_REQUEST_DATE_TIME))  #returns what day of the week the pt bed was requested
ED.clean$timeofday= hour(ED.clean$BED_REQUEST_DATE_TIME)  #time of day the bed request was ordered (units: hour)
ED.clean$monthofrequest=month(ED.clean$BED_REQUEST_DATE_TIME) #month the bed request was ordered
ED.clean$bed_request_date=as.Date(ED.clean$BED_REQUEST_DATE_TIME)  #date the bed request was ordered (without time)

#number of total admission for that day 
a=ED.clean %>%  #look through all ED admissions
  group_by(as.Date(BED_REQUEST_DATE_TIME)) %>%  #group bed requests by date
  summarise(tot_ED_admits.day=n())  #count the total # of bed requests per day; and spit out the number of ED admissions by day
ED.admits.per.day<-dplyr::rename(a, bed_request_date= "as.Date(BED_REQUEST_DATE_TIME)")  #rename column in ED.admits.per.day so both tables will have a column called "bed_request_date" so they can be merged
ED.clean.2=inner_join(ED.clean,ED.admits.per.day,by="bed_request_date")  #merge ED.clean with ED.admits.per.day to obtain column of total admissions that day

ED.clean.3<-ED.clean.2 %>%   #get rid of outliers (if duration is outside range of 0-1000 min, it likely was an error)
  filter(tot.dur>0 & tot.dur<1000) %>%
  filter(dur1.request.report>0 & dur1.request.report<1000) %>%
  filter(dur2.report.floor>0 & dur2.report.floor<1000) %>%
  filter(dur.request.bedassign>0) %>% 
  filter(dur.bedassign.report>0) %>% #this only returns 25731 values (losing almost 8k values)
  return
nrow(ED.clean.3)

#convert durations from minutes to numeric to do calculations
ED.clean.3$dur1.request.report<-as.integer(ED.clean.3$dur1.request.report)
ED.clean.3$dur2.report.floor<-as.integer(ED.clean.3$dur2.report.floor)
ED.clean.3$dur.request.bedassign<-as.integer(ED.clean.3$dur.request.bedassign)
ED.clean.3$dur.bedassign.report<-as.integer(ED.clean.3$dur.bedassign.report)
ED.clean.3$tot.dur<-as.integer(ED.clean.3$tot.dur)
head(ED.clean.3)

##Col4: Inpatient teams renamed
#renaming IP teams:
list1=c("","8S 21671, GP/PULM","9S 21668, GP/NEURO", "9S 72643, GP/NEURO/EPILEPSY", "ADOLESCENT RESIDENT 21669","BLUE RESIDENT 14467, ICS/GP","CARDIOLOGY 17802", "CARDIOLOGY, FLOC A", "CARDIOLOGY, FLOC B","CICU 42644, BLUE","CICU 42644, RED", "FLOC SURGICAL HOSPITALIST, 77707","GOLD COMPLEX-1 11929", "GOLD COMPLEX-2 11928","GREEN RESIDENT 21667, GI","HACU", "HPT A 11927","HPT B 11930","HPT C 11931", "MBU A 74051", "MBU B 74052","MEDICAL HOSPITALIST 10146, TEAM", "ONCOLOGY 15511, RESIDENT LIQUID","ONCOLOGY 72015, RESIDENT SOLID/NEURO","ONCOLOGY, BMT", "ONCOLOGY, LIQUID","ONCOLOGY, NEURO", "ONCOLOGY, SOLID","PCU, ORANGE (ACUTE)","PICU 19041, GREEN", "PICU 19053, RED","PICU 78485, PURPLE","PICU, YELLOW", "RED RESIDENT 21670, HEME/GP", "SSU-SEASONAL STAY UNIT 79427", "YELLOW RESIDENT 19966, ENDO/MET/RENAL", "NICU 15945, BLUE 1","NICU 72517, BLUE 2", "NICU BLUE 2" ,"NICU 25633, PURPLE 1", "NICU 72519, PURPLE 2","NICU 71317, ORANGE 1","NICU 71602, ORANGE 2","NICU 70330, RED","NICU 20132, GREEN","REHAB BLUE TEAM", "REHAB GREEN TEAM","REHAB RED TEAM","ONCO, LIQUID CONSULT")

values1=c("none","8S Resident", "9S Resident", "9S Resident", "Adolescent Resident", "Blue Resident", "Cardiology Team", "Cardiology Team", "Cardiology Team","CICU", "CICU", "Surg Subspecialty", "Gold HPT Team", "Gold HPT Team", "GI Resident", "HACU", "HPT", "HPT","HPT","MBU", "MBU", "MHT", "Onco Resident", "Onco Resident", "Onco Hospitalist","Onco Hospitalist", "Onco Hospitalist", "Onco Hospitalist","PCU", "PICU Green","PICU Resident","PICU Resident" , "PICU Yellow" ,"Red Resident","SSU Resident", "Yellow Resident", "NICU Blue", "NICU Blue", "NICU Blue","NICU purple", "NICU purple","NICU orange", "NICU orange", "NICU red", "NICU green","Rehab","Rehab","Rehab" ,"Onco c/s")
ED.clean.3<-ED.clean.3 %>%
  mutate(INP_TEAM_RENAMED = factor(INPATIENT_TEAM, levels=list1, labels=values1))

##4: Diagnoses Renamed
#Distinct Diagnoses:  There are 3069 different ED diagnoses that were entered for admitted patients
#Method: Find all respiratory diagnoses by looking for the words "asthma, respi or bronchiolitis"
diag.resp=ED.admits.r %>%
  dplyr::select(DIAGNOSIS) %>%
  distinct(DIAGNOSIS) %>%
  filter(grepl('asthma|respi|bronchiolitis', DIAGNOSIS, ignore.case = TRUE)) %>%
  return

a<-vector(); group.diag<-vector()
#for loop: 
# 1) finds all diagnoses that contain "asthma, respi, bronchiolitis, wheezing" and replaces it with "respiratory distress"
# 2) finds all diagnoses containing "" replaces it with "GI distress"
# 3) Finds all diagnoses containing "Sickle-cell, Hb-SS"  replaces it with "Sickle cell"
for(i in 1:nrow(ED.clean.3)){
  a<-grepl('asthma|respi|bronchiolitis|wheezing|dyspnea|shortness of breath', ED.clean.3$DIAGNOSIS[[i]], ignore.case = TRUE) #respiratory distress
  b<-grepl('sickle-cell|hb-ss', ED.clean.3$DIAGNOSIS[[i]], ignore.case = TRUE)  #sickle cell related illness
  c<-grepl('gastrostomy', ED.clean.3$DIAGNOSIS[[i]], ignore.case = TRUE ) #GT malfunction
  d<-grepl('ventricular intracranial', ED.clean.3$DIAGNOSIS[[i]], ignore.case = TRUE ) #VP shunt malfunction
  e<-grepl('fracture', ED.clean.3$DIAGNOSIS[[i]], ignore.case = TRUE )  #this searches for all fractures;
  if(a=="TRUE"){group.diag[i]<- "respiratory distress"}
  else if(a=="FALSE" & b=="TRUE"){group.diag[i]<- "Sickle Cell related"}
  else if(a=="FALSE" & b=="FALSE" & c=="TRUE"){group.diag[i]<- "G-Tube complication"}
  else if(a=="FALSE" & b=="FALSE" & c=="FALSE" & d=="TRUE"){group.diag[i]<- "VP shunt malfunction"}
  else if(a=="FALSE" & b=="FALSE" & c=="FALSE" & d=="FALSE" & e=="TRUE"){group.diag[i]<- "ANY Fracture"}
  else{group.diag[i]<-ED.clean.3$DIAGNOSIS[i]}
}
ED.clean.3$grouped.diagnoses<-group.diag #add to the table of clean data


```


HEADER: Visual Trends / Plots

3. Visual Trends / Plots:
```{r}
#Summary of numeric trends
summary(ED.clean.3$tot.dur)  # median 117, mean 138min, bottom quartile is >164min
summary(ED.clean.3$dur1.request.report)  #median 68, mean 85min, top 25% 107min, top quartile is <42min
summary(ED.clean.3$dur2.report.floor) #median 38min, mean 53min, bottom quartile 67min;  (if it takes >1 hour from signout to going upstairs, not great)
summary(ED.clean.3$dur.request.assigned) #median 26, mean 43min
summary(ED.clean.3$dur.bedassign.report) #median 38 min, mean 48
```

##Questions:
```{r}
#Does duration vary from year to year?  No
plot<- ED.clean.3 %>%
  mutate(year=factor(year(bed_request_date), levels=c("2016","2017","2018"), labels=c("2016", "2017", "2018")))
ggplot(data=plot, aes(x=year, y=dur1.request.report, group=year)) +
      geom_boxplot() +
      theme(axis.text.y = element_text(face="plain", size=10, angle=45))

#Does duration vary by month?
plot<- ED.clean.3 %>%
  group_by(monthofrequest) %>%
  summarise(mean_tot=mean(tot.dur), mean_dur1=mean(dur1.request.report), mean_dur2=mean(dur2.report.floor), count=n())

#Boxplot
ggplot(data=ED.clean.3, aes(x=factor(monthofrequest,levels=c("1","2","3","4","5","6","7","8","9","10","11","12")), y=dur2.report.floor, group=monthofrequest)) + geom_boxplot()+
   scale_x_discrete("month of bed request")
#averages
ggplot()+
  geom_point(data=plot,aes(x=factor(monthofrequest,levels=c("1","2","3","4","5","6","7","8","9","10","11","12")), y=mean_tot,color="black",size=count))+
  geom_point(data=plot,aes(x=factor(monthofrequest,levels=c("1","2","3","4","5","6","7","8","9","10","11","12")), y=mean_dur1,color="green",size=count)) +
  geom_point(data=plot,aes(x=factor(monthofrequest,levels=c("1","2","3","4","5","6","7","8","9","10","11","12")), y=mean_dur2,color="red",size=count))+
  theme(axis.text.x = element_text(face="plain", color="#993333", size=10, angle=60, hjust=1),
        axis.text.y = element_text(face="plain", color="#993333", size=10, angle=45))+
  xlab("Month")+ ylab("Avg Wait Time (min)")+ ggtitle("Wait Time vs Month")+
  scale_colour_manual(name = 'color', values =c('black','red','green'), labels = c('total wait time','bed request to MD report','MD report to arrival to floor'))


#PLOT: Does Duration vary by Day of the Week
weekdays<-c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")
ggplot() +
  geom_boxplot(data=ED.clean.3, aes(x=factor(dayofweek, levels=c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")), y=tot.dur)) + 
  xlab("Day of the Week")+ ylab("Avg Wait Time (min)")+ ggtitle("Wait Time by Day of the Week")
  # geom_boxplot(data=ED.clean.3, aes(x=factor(dayofweek, levels=c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")), y=dur1.request.report))+
  # geom_boxplot(data=ED.clean.3, aes(x=factor(dayofweek, levels=c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")), y=dur2.report.floor))+
     #labels
  #  scale_y_continuous("Wait time in Minutes", limits=c(0,1000))
#ggplot(data=ED.clean.3, aes(x=dayofweek, y=tot.dur, group=dayofweek))+geom_boxplot()

#Plot:  Does Duration vary by Inpatient Bed Location?  
plot1<-ED.clean.3 %>%
  group_by(INPATIENT_FLOOR) %>%
  summarise(mean_tot=mean(tot.dur), mean_dur1=mean(dur1.request.report), mean_dur2=mean(dur2.report.floor), count=n())
plot1<-plot1[!plot1$count<5,] #takes out the outlier teams where the floor only has <5 pts admitted (indicating error)

ggplot()+
  geom_point(data=plot1,aes(x=reorder(INPATIENT_FLOOR,-mean_tot), y=mean_tot, size=count, color="black")) + 
  geom_point(data=plot1,aes(x=INPATIENT_FLOOR, y=mean_dur1, color="red")) +
  geom_point(data=plot1,aes(x=INPATIENT_FLOOR, y=mean_dur2,color="green")) +
       theme(axis.text.x = element_text(face="plain", color="#993333", size=10, angle=45, hjust=1),
             axis.text.y = element_text(face="plain", color="#993333", size=10, angle=45, hjust=1)) +
      xlab("Inpatient Admit Team")+ ylab("Avg Wait Time (min)")+ ggtitle("Wait Time by Inpatient Floor ")+
  scale_colour_manual(name = 'colour', values =c('black','red','green'), labels = c('total wait time','bed request to MD report','MD report to arrival to floor'))

ggplot(data=plot1,
       aes(x=reorder(INPATIENT_FLOOR,-mean_tot), y=mean_tot)) + geom_point() +
       theme(axis.text.x = element_text(face="plain", color="#993333", size=10, angle=60, hjust=1),
             axis.text.y = element_text(face="plain", color="#993333", size=10, angle=45))+
       xlab("Inpatient Floor")+ ylab("Avg Wait Time (min)")+ ggtitle("Wait Time by Inpatient Floor")

#Plot 2:  Does duration vary by Inpatient Team? Yes
plot2 <-ED.clean.3 %>%
  group_by(INP_TEAM_RENAMED) %>%
  summarise(mean_tot=mean(tot.dur), mean_dur1=mean(dur1.request.report), mean_dur2=mean(dur2.report.floor), count=n()) %>%
  arrange(desc(mean_tot)) %>%
  return

#Inpatient TEAM  plot
ggplot()+
  geom_point(data=plot2,aes(x=reorder(INP_TEAM_RENAMED,-mean_tot), y=mean_tot, size=count, color="black")) + 
  geom_point(data=plot2,aes(x=INP_TEAM_RENAMED, y=mean_dur1, color="red")) +
  geom_point(data=plot2,aes(x=INP_TEAM_RENAMED, y=mean_dur2,color="green")) +
       theme(axis.text.x = element_text(face="plain", color="#993333", size=10, angle=45, hjust=1),
             axis.text.y = element_text(face="plain", color="#993333", size=10, angle=45, hjust=1)) +
      xlab("Inpatient Admit Team")+ ylab("Avg Wait Time (min)")+ ggtitle("Wait Time by Inpatient Admit Team")+
  scale_colour_manual(name = 'colour', values =c('black','red','green'), labels = c('total wait time','bed request to MD report','MD report to arrival to floor'))

#Inpatient Boxplot
ggplot(data=ED.clean.3, aes(x=INP_TEAM_RENAMED, y=tot.dur, group=INP_TEAM_RENAMED)) +geom_boxplot() +
   ggtitle("ED Wait Time vs Inpatient Team") +
   theme(axis.text.x = element_text(face="plain", color="#993333",size=10, angle=65, hjust = 1)) +
  xlab("Inpatient Admit Team")+ ylab("Avg Wait Time (min)")+ ggtitle("Wait Time by Inpatient Admit Team")

#Does wait time vary by service?
plot8 <-ED.clean.3 %>%
  group_by(INPATIENT_SERVICE) %>%
  summarise(mean_tot=mean(tot.dur), mean_dur1=mean(dur1.request.report), mean_dur2=mean(dur2.report.floor), count=n())
plot8<-plot8[!plot8$count<2,] #takes out the outlier teams where the floor only has <5 pts admitted (indicating error)
  
ggplot(data=plot8, aes(x=reorder(INPATIENT_SERVICE,-mean_tot), y=mean_tot)) +geom_point() +
   ggtitle("ED Wait Time vs Service Team") +
   theme(axis.text.x = element_text(face="plain", color="#993333",size=8, angle=65, hjust = 1)) +
  xlab("Inpatient Service")+ ylab("Avg Wait Time (min)")+ ggtitle("Wait Time by Service")

ggplot(data=ED.clean.3, aes(x=INPATIENT_SERVICE, y=tot.dur, group=INPATIENT_SERVICE)) +geom_boxplot() +
   ggtitle("ED Wait Time vs Service Team") +
   theme(axis.text.x = element_text(face="plain", color="#993333",size=8, angle=65, hjust = 1)) +
  xlab("Inpatient Service")+ ylab("Avg Wait Time (min)")+ ggtitle("Wait Time by Service")

#Does it vary by time of day that the admission bed request was placed?  yes
plot3<-ED.clean.3 %>%
  group_by(timeofday) %>%
  summarise(mean_tot=mean(tot.dur), mean_dur1=mean(dur1.request.report), mean_dur2=mean(dur2.report.floor), patients=n())

ggplot()+geom_point(data=plot3, aes(x=reorder(timeofday,+timeofday), y=mean_tot, color="black",size=patients)) +
  geom_point(data=plot3, aes(x=reorder(timeofday,+timeofday), y=mean_dur1, color="green", size=patients)) +
  geom_point(data=plot3, aes(x=reorder(timeofday,+timeofday), y=mean_dur2, color="red", size=patients)) +
  theme(axis.text.x = element_text(face="plain", color="#993333", size=9, angle=70, hjust=1),
             axis.text.y = element_text(face="plain", color="#993333",size=9, angle=60, hjust=1)) +
  xlab("Time of Bed Request (hour)") + ylab("Average Wait Time (min)") +ggtitle("Wait Time vs Hour of Bed Request")+
    scale_colour_manual(name = 'colour', values =c('black','green','red'), labels = c('total wait time','bed request to MD report','MD report to arrival to floor'))
#  scale_colour_manual(name = 'colour', values =c('black'='black','red'='red','green'='green'), labels = c('c2','c1','c3'))

#Does it vary by diagnosis?
plot4 <- ED.clean.3 %>%
  group_by(grouped.diagnoses) %>%
  summarise(mean_tot=mean(tot.dur), mean_dur1=mean(dur1.request.report), mean_dur2=mean(dur2.report.floor), count=n())
plot4<-plot4[plot4$count>100,]
ggplot()+
  geom_point(data=plot4,aes(x=reorder(grouped.diagnoses,-mean_tot),y=mean_tot, color="black",size=count))  +
  geom_point(data=plot4,aes(x=grouped.diagnoses, y=mean_dur1, color="green",size=count)) +
  geom_point(data=plot4,aes(x=grouped.diagnoses, y=mean_dur2, color="red",size=count)) +
       theme(axis.text.x = element_text(face="plain", color="#993333", size=6, angle=70, hjust=1),
             axis.text.y = element_text(face="plain", color="#993333",size=6, angle=45)) +
      xlab("Diagnosis") + ylab("Average Wait Time (min)") +ggtitle("Wait Time vs Diagnosis")+
  scale_colour_manual(name = 'colour', values =c('black','green','red'), labels = c('total wait time','bed request to MD report','MD report to arrival to floor'))

#Is wait time related to # of Bed Requests made that day?
plot7 <- ED.clean.3 %>%
  group_by(tot_ED_admits.day) %>%
  summarise(mean_tot=mean(tot.dur), mean_dur1=mean(dur1.request.report), mean_dur2=mean(dur2.report.floor), count=n())
ggplot()+
  geom_point(data=plot7,aes(x=tot_ED_admits.day, y=mean_tot))+
  #geom_point(data=plot7,aes(x=tot_ED_admits.day, y=mean_dur1, color="red"))+
  #geom_point(data=plot7,aes(x=tot_ED_admits.day, y=mean_dur2, color="green"))+
       theme(axis.text.x = element_text(face="plain", color="#993333", size=6, angle=70, hjust=1),
             axis.text.y = element_text(face="plain", color="#993333",size=6, angle=45))+
  xlab("# Admission Requests / day") + ylab("Average Wait Time (min)") +ggtitle("Wait Time vs # of ED Admission Requests")
 # scale_colour_manual(name = 'color', values =c('black','red','green'), labels = c('total wait time','bed request to MD report','MD report to arrival to floor'))

  
#Is Duration related to total ED bed requests that day
```

Regression:
```{r}
colnames(ED.clean.3)

data.regression <- ED.clean.3 %>%
  select(dur1.request.report, dur2.report.floor, dur.request.bedassign, dur.bedassign.report, tot.dur, DIAGNOSIS, dayofweek, tot_ED_admits.day, TEAM_ED, timeofday, INP_TEAM_RENAMED, INPATIENT_FLOOR, monthofrequest, grouped.diagnoses, bed_request_date)

#univariate linear regression
summary((lm(tot.dur ~ dayofweek, data=ED.clean.3, family=binomial())))  #yes for Saturday, Sunday, Monday
summary((lm(tot.dur ~ tot_ED_admits.day, data=ED.clean.3, family=binomial())))  #yes
summary((lm(tot.dur ~ TEAM_ED, data=ED.clean.3, family=binomial())))  #only if its team 6, trauma
summary((lm(tot.dur ~ timeofday, data=ED.clean.3, family=binomial()))) #not singularly
summary((lm(tot.dur ~ INP_TEAM_RENAMED, data=ED.clean.3, family=binomial())))
summary((lm(tot.dur ~ INPATIENT_FLOOR, data=ED.clean.3, family=binomial())))
summary((lm(tot.dur ~ monthofrequest, data=ED.clean.3, family=binomial()))) #no
summary((lm(tot.dur ~ grouped.diagnoses, data=ED.clean.3, family=binomial()))) #no
summary((lm(tot.dur ~ bed_request_date, data=ED.clean.3, family=binomial())))

#multivariable regression
summary((lm(tot.dur~ dayofweek + tot_ED_admits.day+TEAM_ED+timeofday+INPATIENT_SERVICE+INP_TEAM_RENAMED, data=ED.clean.3)))
head(ED.clean.3)
#convert total duration into a dichotomous variable (>150 min is too long) and rerun analysis
data.dichotomous.clean <- ED.clean.3 %>%
  mutate(wait_time_long = cut(tot.dur, breaks=c(0, 120, 1000), labels=c("no", "yes"))) %>%
  mutate(reqtoreport_long = cut(dur1.request.report, breaks=c(0, 120, 1000),labels=c("no", "yes"))) %>%
  mutate(reporttoINP_long = cut(dur2.report.floor, breaks=c(0,60,1000), labels=c("no", "yes"))) %>%
  mutate(reqtoassigned_long = cut(dur.request.bedassign, breaks=c(0,60,1000), labels=c("no", "yes"))) %>%
  mutate(assigntoreport_long = cut(dur.bedassign.report, breaks=c(0,30,1000), labels=c("no", "yes")))  #from bed assigned to report it takes much longer than 30 min
  
#plot 1
ggplot(data=data.dichotomous.clean, aes(x=INP_TEAM_RENAMED, fill=assigntoreport_long)) +
      geom_bar(position="dodge") +
      theme(axis.text.x = element_text(face="plain", color="#993333", size=6, angle=70, hjust=1),
            axis.text.y = element_text(face="plain", color="#993333",size=6, angle=45))
 # xlab("# Admission Requests / day") + ylab("Average Wait Time (min)") +ggtitle("Wait Time vs # of ED Admission Requests")
#what if we had inpatient page downstairs when bed is assigned????

#plot 2
ggplot(data=data.dichotomous.clean, aes(x=INP_TEAM_RENAMED, fill=reqtoassigned)) +
      geom_bar(position="dodge") +
      theme(axis.text.x = element_text(face="plain", color="#993333", size=6, angle=70, hjust=1),
            axis.text.y = element_text(face="plain", color="#993333",size=6, angle=45))
```

Who are the outliers?  There seems to be a large group per month
```{r}
outliers<-ED.clean.3 %>%
  filter(dur2.report.floor>70) %>%
  return
  
outliers %>%
  group_by(INP_TEAM_RENAMED) %>%
  summarise(count=n()) %>%
  arrange(desc(count))

a=outliers %>%
  group_by(grouped.diagnoses) %>%
  summarise(count=n()) 

poop=outliers %>%
  group_by(INPATIENT_FLOOR) %>%
  summarise(count=n())

a=outliers %>%
  group_by(INPATIENT_SERVICE) %>%
  summarise(count=n()) 
b=ED.clean.3 %>%
  group_by(INPATIENT_SERVICE) %>%
  summarise(total=n())
c=inner_join(a,b,by="INPATIENT_SERVICE");
c$percent=c$count/c$total*100
#The percent of outliers each service has 
c %>%
  arrange(desc(percent))
```



Basket of evaluations for now:
```{r}




#ED.data.renamed <- rename(ED.data, diagnosis=ACCT_ADMIT_DX_NM, mrn=PAT_MRN_ID,  admitted_from=FROM_DEPT, admit_floor=CENSUS_ADMIT_DEPT, time_bed_request = MRFT_BED_REQ_DT_TM, time_md_paged=MD_PAGED_DT_TM, treatment_team_start_time = ADMIT_TREATMENT_START_DT, time_bed_assigned = BED_ASSIGN_DT_TM,  time_md_report=MD_RPT_DT_TM, ed_team=ED_DISCH_TEAM, admit_service_team=CENSUS_ADMIT_SERVCIE, time_of_arrival=HOSP_ADMIT_DT, time_of_admission=CENSUS_ADMIT_TM )
#wish list:  bed assignment time; Inpatient team

#calculations
# need time between bed request and MD paged, time between MD paged and MD report, time between Bed request and MD report, time to bed request and patient hitting the floor (probably the actual outcome measure)
#Things that seem to be missing:demographics of the patient, age, # of medications, problems on the problem list, # of labs ordered
#could complexity be a proxy measure by duration of admission?
#new.columns.data

##quick code to convert to days of the week!!!!  cool
#crime_date = as.Date(ymd_hms(ED.clean$time_bed_assigned))
#summary(crime_date)
#crime_date_dotw=weekdays(crime_date)
#hist(crime_date, breaks="month")


# #convert time data to be computable
# col1 <-ymd_hms(admissions.data.renamed$time_bed_request) ##add a column that looks at time_hour, and takes out the hour the flight was scheduled to depart
# col2 <-ymd_hms(admissions.data.renamed$time_md_paged)
# col3 <-ymd_hms(admissions.data.renamed$time_md_report)
# col4 <-ymd_hms(admissions.data.renamed$time_of_admission)
# 
# #calculate durations between points of interest
# duration.bedrequesttomdpage <-difftime(col2,col1,units="min")  #duration between time of bed request to MD page 
# duration.mdpagetomdreport <-difftime(col3,col2, units="min")  #duration between MD paged to MD report given
# duration.mdreporttotime_of_admission <-difftime(col4,col3, units="min")  #duration between MD reported to Time of Admission
# total.duration<-difftime(col4,col1, units="min") #duration between time MD was paged to Time of Admission
# #add columns to data table
# data.with.durations<-cbind(admissions.data.renamed, duration.bedrequesttomdpage, duration.mdpagetomdreport, duration.mdreporttotime_of_admission, total.duration)
# summary(a)
# 
# #look at ED data set only
# col1a <-ymd_hms(ED.data.renamed$time_bed_request) ##add a column that looks at time_hour, and takes out the hour the flight was scheduled to depart
# col2a <-ymd_hms(ED.data.renamed$time_bed_assigned) #time of bed assignment
# col3a<-ymd_hms(ED.data.renamed$time_md_paged)#time of MD paged
# col4a<-ymd_hms(ED.data.renamed$time_md_report) #Time MD report was given
# col5a <-ymd_hms(ED.data.renamed$time_of_admission)  #time of admission on inpatient
# 
# duration21<-difftime(col2a,col1a, units="min") #time between bed assigned (2) and bed request (1)
# duration_pagetorequest<-difftime(col3a,col1a, units="min")  #time between MD page and bed request
# duration32<-difftime(col3a,col2a, units="min") #time between MD paged and bed assigned;  if negative, specialty team was consulted (and button was clicked, but not the time that the team actually signed out)
# duration42<-difftime(col4a,col2a, units="min") # time between MD report and bed assigned
# duration41<-difftime(col4a,col1a, units="min")  #total duration between time of bed request to MD Report
# duration54<-difftime(col5a,col4a, units="min")  #total duration between MD report to bed admission time
# n<-duration54<(-0)
# summary(n)
# ED.data.with.durations<-cbind(duration32, duration42, poop, duration_pagetorequest, ED.data.renamed)
# 
# 
# #total duration from bed request to time of admission on the floor
# #errors:  large durations due to being admitted to PICU after being admitted to floor or just an error in general
# #find the outliers here
# poop<- difftime(col5a,col1a,unit="min")
# which(poop>1000)
# a=ED.data.with.durations[281,]
# str(a)
# str(poop)
# mean(poop[1:37241], na.rm=TRUE)
# median(poop[1:37241], na.rm=TRUE)
# 
# #plots
# ggplot(data=ED.data.with.durations,aes(x=year(col1a), y=poop)) +
#         geom_boxplot()
# 
# #NOTE:  bed request to MD report shoudl be the time outcome measure;  the bed request is when teh patient is deemed medically safe to initiate finding a bed.  MD report is when the MD has given the report.  The time between Bed request to MD page is loaded with errors (1/3 of the time MD paged is referring to when consult team is paged, other time is missing), the time between MD 
# 
# #Filter to only see ED admissions
# ed.admissions <- data.with.durations %>%
#   filter(admitted_from != "ED") %>%
#   group_by(hour(ymd_hms(time_of_admission))) %>%
#   summarize(count=n()) %>%
#   arrange(desc(count))
# poop1 <- cbind(ed.admissions[,1], ed.admissions[,2]*100/sum(ed.admissions[,2]))
# 
# month(ymd_hms(data.with.durations$time_bed_request))
# 
# # Total count of all admissions from ED:: GROUP BY TREATMENT TEAM
# num.ed.admissions <- ED.data.with.durations %>%
#   filter(admitted_from=="ED") %>%
#   group_by(ADMIT_TREATMENT_TEAM) %>%
#   summarize(count=n())%>%
#   arrange(desc(count)) 
# a=cbind(num.ed.admissions[,1] , (num.ed.admissions[,2]/sum(num.ed.admissions[,2])*100))
# 
# ## Total count of all admissions from ED: Group by floor
# num.ed.admissions <- ED.data.with.durations %>%
#   filter(admitted_from=="ED") %>%
#   group_by(admit_floor) %>%
#   summarize(count=n())%>%
#   arrange(desc(count)) 
# b=cbind(num.ed.admissions[,1] , (num.ed.admissions[,2]/sum(num.ed.admissions[,2])*100))
# 
# ## Total count of all admissions from ED: Group by service
# num.ed.admissions <- ED.data.with.durations %>%
#   filter(admitted_from=="ED") %>%
#   group_by(admit_service_team) %>%
#   summarize(count=n())%>%
#   arrange(desc(count)) 
# c=cbind(num.ed.admissions[,1] , (num.ed.admissions[,2]))
# #54% of all admissions at CHOP come from the ED
# 
# #Top diagnoses admitted from ED
# admission.diagnoses<- data.with.durations %>%
#   filter(admitted_from=="ED") %>%
#   group_by(diagnosis) %>%
#   summarize(count=n()) %>%
#   arrange(desc(count)) 

#If the diagnosis has the word asthma in it, then rename diagnosis as asthma
#The top 10 admission diagnoses included - fever, dyspnea, acute bronchiolitis, vomiting, convulsions, abdominal pain, appendicitis, asthma, ARDS, pneumonia, dehydration, wheezing, SS crisis, headache, cough.  But asthma shows up in a bunch of the various diagnoses.

#graphs
#X=

# graph 2: X - floor they were admitted to, Y duration
# graph 3: 
# when bed gets requested and then changed

  
#counts of admissions in 1 day, overlaid with admission duration time 
#filter
# look only at kids admitted from the ED

```


### Methods
In the first paragraph, describe the data used and general methodological approach. Subsequently, incorporate full R code necessary to retrieve and clean data, and perform analysis. Be sure to include a description of code so that others (including your future self) can understand what you are doing and why. 

```{r}
#clean up the data:
# Basic graph plots of time to admission from ED to arrival on inpatient
# graph 2: X - floor they were admitted to, Y duration
# graph 3: 
```

### Results
Describe your results and include relevant tables, plots, and code/comments used to obtain them. End with a brief conclusion of your findings related to the question you set out to address. You can include references if you'd like, but this is not required.
